<?include("app/views/scripts/header.phtml");?>
<script type="text/javascript" src="<?=base()?>/lib/jquery-1.3.2/plugins/jquery.textarearesizer.js"></script>
<style type="text/css">
        div.grippie {
                background:#EEEEEE url(<?=base()?>/images/grippie.png) no-repeat scroll center 2px;
                border-color:#DDDDDD;
                border-style:solid;
                border-width:0pt 1px 1px;
                cursor:s-resize;
                height:9px;
                overflow:hidden;
        }
        .resizable-textarea textarea {
                display:block;
                margin-bottom:0pt;
                width:95%;
                height: 20%;
        }
</style>

<div class="bread">You are here &gt; <a href="<?=base()?>/navigator"><?=submenutitle($this->submenu_selected)?></a> &gt; <?=$this->ticket_id?></div>
<?
if($this->ticket_type == "Security") {
    echo "<p class=\"errors\">This is a security ticket that only authorized persons can view. Please do NOT forward the contents of this ticket to any one without the OSG security team's consent</p>";
} else if($this->ticket_type == "Security_Notification") {
    echo "<p class=\"errors\">This is a security notification ticket which is only accecible for registered OIM users. Please do not forward the content of this ticket to anyone.</p>";
}

?>

<script type="text/javascript">
function gotoedit()
{
    $("#editbutton").attr("disabled", "disabled");
    $("#editbutton").val("Loading...");
    $("#information_table").load("<?=fullbase()?>/viewer/edit?id=<?=$this->ticket_id?>");
}
</script>

<?if($this->editable) {?>
    <form action="<?=fullbase()?>/viewer/update" method="post">
        <input type="hidden" name="id" value="<?=$this->ticket_id?>"/>

        <!--span class="header">Title:</span-->
        <input type="text" style="width: 455px" name="title" value="<?=$this->title?>"/>
        <br/>

        <h3>Ticket Detail</h3>

        <table class="ticket_detail" width="100%">
        <tr><td width="430px">

            <h4>Submitter</h4>
            <span class="header">First Name:</span>
            <input type="text" value="<?=$this->submitter_fname?>" name="submitter_fname"/>
            <br/>

            <span class="header">Last Name:</span>
            <input type="text" value="<?=$this->submitter_lname?>" name="submitter_lname"/>
            <br/>

            <span class="header">Email:</span>
            <input type="text" value="<?=$this->submitter_email?>" name="submitter_email"/>
            <br/>

            <span class="header">Phone:</span>
            <input type="text" value="<?=$this->submitter_phone?>" name="submitter_phone"/>
            <br/>

            <h4>Other Information</h4>
            <span class="header">Ticket Type:</span>
            <select name="ticket_type">
            <?
            $ttype = Footprint::GetTicketTypes();
            foreach($ttype as $type) {
                $selected = "";
                if($type == $this->ticket_type) $selected = "selected=selected";
                echo "<option value=\"$type\" $selected>$type</option>";
            }
            ?>
            </select>
            <br/>

            <span class="header">Priority:</span>
            <select name="priority">
            <?
            $plist = Footprint::GetPriorityList();
            foreach($plist as $id=>$p) {
                $selected = "";
                if($p == $this->priority) $selected = "selected=selected";
                echo "<option value=\"$id\" value=\"$id\" $selected>$p</option>";
            }
            ?>
            </select>
            <br/>

            <span class="header">Status:</span>
            <?
            $style = status2style($this->status);
            echo "<select name=\"status\">";
            foreach(Footprint::GetStatusList() as $status) {
                $selected = "";
                if($status == $this->status) $selected = "selected=selected";
                $style = status2style($status);
                echo "<option value=\"$status\" $selected class='ticketid $style'>$status</option>";
            }
            ?>
            </select>
            <br/>

            <span class="header">Next Action Deadline:</span>
            <input type="text" name="nad" value="<?=$this->nad?>"/>
            <br/>

            <span class="header">Next Action Item:</span>
            <input type="text" name="next_action" value="<?=$this->next_action?>"/>
            <br/>

            <table><tr>
            <td style="padding: 0px;">
                <span class="header">CC:</span>
            </td>
            <td style="padding-left: 3px;">
                <div class="ccarea">
                    <?
                    foreach($this->cc as $cc) {
                        echo "<div class=\"cc\"><input type=\"text\" class=\"cc\" name=\"cc[]\" value=\"$cc\"/><a href=\"#\" onclick=\"$(this).parents('div.cc').remove();return false;\"><img src=\"".fullbase()."/images/delete.png\"/></a></div>";
                    }
                    ?>
                    <script type="text/javascript">
                    function addcc(node)
                    {
                        var template = "<div class=\"cc\"><input type=\"text\" class=\"cc\" name=\"cc[]\"/><a href=\"#\" onclick=\"$(this).parents('div.cc').remove();return false;\"><img src=\"<?=fullbase()?>/images/delete.png\"/></a></div>";
                        node.append(template);
                        setup_cc();
                    }
                    <?
                    $model = new Person();
                    $persons = $model->fetchAll();
                    $persons_json = "";
                    foreach($persons as $person) 
                    {
                        $name = trim($person->name);
                        $email = trim($person->primary_email);
                        if($name == "") $name = $email;
                        if($persons_json != "") $persons_json .= ",\n";
                        $persons_json .= "{ name: \"$name\", email: \"$email\"}";
                    }
                    ?>
                    var persons = [
                        <?=$persons_json?>
                    ];
                    $(document).ready(function() {
                        setup_cc();
                    });
                    function setup_cc()
                    {
                        $(".cc").autocomplete(persons, {
                            mustMatch: false,
                            matchContains: true,
                            width: 500,
                            formatItem: function(row, i, max) {
                                return row.name + "<br/>Email: " + row.email;
                            },
                            formatMatch: function(row, i, max) {
                                return row.name + " " + row.email;
                            },
                            formatResult: function(row) {
                                return row.email;
                            }
                        });
                    }

                    </script>
                </div>
                <a class="button" href="#" onclick="addcc($(this).siblings('div.ccarea'));return false;">Add New CC</a>
                <br/>
            </td>
            </tr></table>
        </td>
        <td>
            <h4>Routing Information</h4>
            <span class="header">Originating VO:</span>
            <select name="submitter_vo">
            <?
            foreach($this->originating_vos as $id=>$vo) {
                $selected = "";
                if($vo == $this->submitter_vo) $selected = "selected=selected";
                echo "<option value=\"$vo\" $selected>".Footprint::parse($vo)."</option>";
            }
            ?>
            </select>
            <br/>

            <span class="header">Originating Ticket ID:</span>
            <input type="text" value="<?=$this->originating_ticket_id?>" name="originating_ticket_id"/>
            <br/>

            <span class="header">Destination VO:</span>
            <select name="destination_vo">
            <?
            foreach($this->destination_vos as $id=>$vo) {
                $selected = "";
                if($vo == $this->destination_vo) $selected = "selected=selected";
                echo "<option value=\"$vo\" $selected>".Footprint::parse($vo)."</option>";
            }
            ?>
            </select>
            <br/>

            <span class="header">Destination Ticket ID:</span>
            <input type="text" value="<?=$this->destination_ticket_id?>" name="destination_ticket_id"/>
            <br/>

            <h4>Assignees:</h4>
            <?
            function showTeams($teams, $assignees, $ids, $txlinks) {
                foreach($ids as $id) {
                    $team = $teams[$id];
                    echo "<h5>".Footprint::parse($team->team)."</h5>";
                    if(sizeof($team->members) > 7) {
                        echo fblist("team_$id", $team->members, $assignees);
                    } else {
                        echo checklist("team_$id", $team->members, $assignees, $txlinks);
                    }
                }
            }
            echo "<table width=\"100%\">";
            echo "<tr><td>";
            showTeams($this->teams, $this->assignees, config()->editor_teams[0], $this->txlinks);
            echo "</td><td>";
            showTeams($this->teams, $this->assignees, config()->editor_teams[1], $this->txlinks);
            echo "</td><td>";
            showTeams($this->teams, $this->assignees, config()->editor_teams[2], $this->txlinks);
            echo "</td></tr>";
            echo "</table>";
            ?>
        </td>
        </tr></table>

        <span class="header">New Update:</span>
        <select name="quickdesc" onchange="
            $('.resizable').val('Loading...');
            $.ajax({
                url: '<?=fullbase()?>/viewer/quickdesc?id='+escape($(this).val()),
                success: function(data) {
                    $('.resizable').val(data);
                }
            });
            ">  
        <?
        $model = new Schema();
        $descs = $model->getquickdesc();
        echo "<option>(Quick Description)</option>";
        foreach($descs as $name=>$desc) {
            echo "<option value=\"$name\">$name</option>";
        }
        ?>
        </select>
        <textarea class="resizable" style="width: 98%" rows="5" name="description" onkeypress="checkTab(event);"></textarea>
        <br/>

        <input type="submit" value="&nbsp;&nbsp;&nbsp;Update&nbsp;&nbsp;&nbsp;"/>

    </form>

    <script type="text/javascript" src="<?=fullbase()?>/lib/checktab.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {
        $("input[name='nad']").datepicker({
            dateFormat: 'yy-mm-dd'
        });
        $('textarea.resizable').TextAreaResizer();
    });
    </script>
<?} else {?>
    <div id="information_table">
        <b><?=$this->title?></b>
        <table width="100%">
        <tr>
            <td colspan="4"><h3>Ticket Detail</h3></td>
        </tr>
        <tr>
            <td colspan="4"><h4>Submitter</h4></td>
        </tr>
        <tr>
            <td class="header">Full Name</td><td><?=$this->submitter_name?></td>
            <td></td><td></td>
        </tr>
        <?
            if(user()->getPersonID() !== null) {
                echo "<tr>";
                echo "<td class=\"header\">Email</td><td>".$this->submitter_email."</td>";
                echo "<td class=\"header\">Phone</td><td>".$this->submitter_phone."</td>";
                echo "</tr>";
            }
        ?>
        <tr>
            <td colspan="4"><h4>Routing Information</h4></td>
        </tr>
        <tr>
            <td class="header">Originating VO</td><td><?=$this->submitter_vo?></td>
            <td class="header">Originating Ticket ID</td><td><?=$this->originating_ticket_id?></td>
        </tr>
        <tr>
            <td class="header">Destination VO</td><td><?=$this->destination_vo?></td>
            <td class="header">Destination Ticket ID</td><td><?=$this->destination_ticket_id?></td>
        </tr>

        <tr>
            <td colspan="4"><h4>Other Information</h4></td>
        </tr>
        <tr>
            <td class="header">Ticket Type</td><td><?=$this->ticket_type?></td>
            <td rowspan="6" class="header">Assignees:</td><td rowspan="5">
            <?
            foreach($this->teams as $team_id => $team) {
                $out = "";

                $name = Footprint::parse($team->team);
                $out .= "<h5>$name</h5>";
                $out .= "<p>";
                $set = false;
                foreach($team->members as $userid=>$username) {
                    if(isset($this->assignees[$userid])) {
                        $out .= $username."<br/>";
                        $set = true;
                    }
                }
                $out .= "</p>";
                if($set) {
                    echo $out;
                }
            }
            ?>
            </td>
        </tr>
        <tr>
            <td class="header">Priority</td><td><?=$this->priority?></td>
        </tr>

        <tr>
            <td class="header">Status</td><td><?=$this->status?></td>
        </tr>

        <tr>
            <td class="header">Next Action Deadline</td><td class='<?$style = nadstyle($this->nad);if($style != "") echo "flag $style";?>'><?=$this->nad?></td>
        </tr>

        <tr>
            <td class="header">Next Action Item</td><td><?=$this->next_action?></td>
        </tr>

        <tr>
        <?if(user()->getPersonID() !== null) { ?>
             <td class="header">CC:</td><td>
                <?  foreach($this->cc as $cc) { echo $cc."<br/>"; } ?>
            </td>
        <?}?>
        </tr>

        </table>
    </div>
<?}?>
<br/>

<div id="updates" style="clear: both;">
    <?
    $sort_order = "down";
    if(isset($_REQUEST["sort"])) {
        $sort_order = $_REQUEST["sort"];
    }
    $flip_url = str_replace(array("&sort=up", "&sort=down"), "", fullurl());
    if($sort_order == "down") {
        $flip_url .= "&sort=up";
        $flip_button = "images/up.png";
        krsort($this->descs, SORT_NUMERIC);
    } else {
        $flip_url .= "&sort=down";
        $flip_button = "images/down.png";
        ksort($this->descs, SORT_NUMERIC);
    }
    ?>
    <h3>Updates</h3>
    <p>
        <span style="float: right"><a href="<?=$flip_url?>">Reverse Sorting Order</a>&nbsp;<img align="top" src="<?=$flip_button?>"/></span>
        <?
        $subject = "Open Science Grid: $this->title ISSUE=$this->ticket_id PROJ=".config()->project_id;
        if(!isset($_REQUEST["expandall"])) {
            $expand_all_url = fullurl()."&expandall=true";
            echo "<a style=\"float: right; margin-right: 10px;\" href=\"$expand_all_url\">Expand All Descriptions</a>";
        }
        ?>
        <a href="mailto:<?=config()->ticket_update_address?>?subject=<?=urlencode($subject)?>">Send Update Via Email</a>
    </p>
    <?
    foreach($this->descs as $time=>$desc)
    {
        $by = $desc["by"];
        $content = $desc["content"];
        $type = $desc["type"];

        //hide meta information if user doesn't have metatag access
        if(!user()->allows("view_meta")) {
            $metapos = strpos($content, config()->metatag);
            if($metapos !== FALSE) {
                //has metainfo.. hide it
                $content = substr($content, 0, $metapos);
            }
        }

        if($time > time() - 60*60*24) {
            //show in "ago" format
            $human_time = agoCalculation($time). " ago";
        } else {
            $human_time = date(config()->date_format_full, $time);
        }

        if($type == "history") {
            echo "<div class='update_history'>";
            $out = "<pre>".Footprint::parse($content)."</pre>";
            echo outputToggle("Internal Activities ($human_time)", "Internal Activities ($human_time)", $out);
            echo "</div>";
        }
        
        if($type == "description") {
            $anchor = $time;
            echo "<div class='update_description'>";
            echo "<div class='header'><a name=\"$anchor\">&nbsp;</a>$human_time by <b>$by</b><img style=\"padding-right: 3px;\" onclick=\"document.location='#$anchor'; reset_anchor();\" class=\"anchor_img\" align=\"right\" src=\"images/application_link.png\"/></div>";
            $lines_raw = split("\n", $content);
            $lines = array();
            foreach($lines_raw as $line) {
                $line = trim($line);
                if(strpos($line, "&#62;") === 0) {
                    $line = "<font color='#7F7E6F'>$line</font>";
                }
                $lines[] = $line;
            }
            $content = implode("\n", $lines);
            if(!isset($_REQUEST["expandall"]) && count($lines) > config()->description_showlines) {
                $i = 0;
                echo "<pre>";
                for(;$i < config()->description_showlines; $i++) {
                    echo $lines[$i]."\n";
                }
                echo "</pre>";
                //and toggle the rest..
                $out = "";
                $out .= "<pre>";
                for(;$i < count($lines);$i++) {
                    $out .= $lines[$i]."\n";
                }
                $out .= "</pre>\n";

                echo outputToggle("Show More", "", $out);
            } else {
                //display all at once.
                echo "<pre>$content</pre>";
            }
            echo "</div>";
        }
    }
    ?>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");

    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
$(document).ready(function() {
    reset_anchor();
});
</script>
<?include("app/views/scripts/footer.phtml");?>
