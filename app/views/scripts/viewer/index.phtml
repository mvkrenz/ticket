<?include("app/views/scripts/header.phtml");?>
<div class="bread">You are here &gt; <a href="<?=base()?>/opentickets"><?=submenutitle($this->submenu_selected)?></a> &gt; <?=$this->ticket_id?></div>
<?
if(isset($this->warning)) {
    echo "<p class=\"warning\">".$this->warning."</p>";
}
?>
<h2><?=$this->page_title?></h2>

<div>
<table width="100%">
<tr>
    <td colspan="4"><h3>Submitter</h3></td>
</tr>
<tr>
    <td class="header">Name:</td><td><?=$this->submitter_name?></td>
    <td class="header">Originating VO:</td><td><?=$this->submitter_vo?></td>
</tr>
<?
    if(user()->getPersonID() !== null) {
        echo "<tr>";
        echo "<td class=\"header personal\">Email:</td><td>".$this->submitter_email."</td>";
        echo "<td class=\"header personal\">Phone:</td><td>".$this->submitter_phone."</td>";
        echo "</tr>";
    }

    if($this->originating_ticket_id != "") {
        echo "<tr>";
        echo "<td class=\"header\">Originating Ticket ID</td><td>".$this->originating_ticket_id."</td>";
        echo "<td class=\"header\"></td><td></td>";
        echo "</tr>";
    }
?>
<tr>
    <td colspan="4"><h3>Ticket Info</h3></td>
</tr>
<tr>
    <td class="header">Ticket Type:</td><td><?=$this->ticket_type?></td>
    <td class="header">Destination VO:</td><td><?=$this->destination_vo?></td>
</tr>

<tr>
    <td class="header">Priority:</td><td><?=$this->priority?></td>
    <td class="header personal">CC:</td>
    <td>
    <?
        if(user()->getPersonID() !== null) {
            echo $this->cc;
        }
    ?>
    </td>
</tr>

<tr>
    <td class="header">Status:</td><td><?=$this->status?></td>
    <td rowspan="2" class="header">Assignees:</td><td rowspan="2"><?=$this->assignees?></td>
</tr>
<tr>
    <td class="header">Next Action Deadline:</td><td><?=$this->nad?></td>
</td>
</table>

</div>

<div style="clear: both;">
<h3>Updates</h3>
<br/>
<?
foreach($this->descs as $time=>$desc)
{
    $by = $desc["by"];
    $content = $desc["content"];
    $type = $desc["type"];

    //suppress metainfo..
    $metapos = strpos($content, config()->metatag);
    if($metapos !== FALSE) {
        //has metainfo.. replace it with filtered versionme
        $content = substr($content, 0, $metapos);
    }

    if($time > time() - 60*60*24) {
        //show in "ago" format
        $human_time = agoCalculation($time). " ago";
    } else {
        $human_time = date(config()->date_format_full, $time);
    }

    if($type == "history") {
        echo "<div class='update_history'>";
        $out = "<pre>$content</pre>";
        echo outputToggle("Internal Activities on $human_time", "Hide Internal Activities on $human_time", $out);
        echo "</div>";
    }
    
    if($type == "description") {
        echo "<div class='update_description'>";
        echo "<div class='header'>$human_time by <b>$by</b></div>";
        $lines_raw = split("\n", $content);
        $lines = array();
        foreach($lines_raw as $line) {
            $line = trim($line);
            if(strpos($line, "&#62;") === 0) {
                $line = "<font color='#7F7E6F'>$line</font>";
            }
            $lines[] = $line;
        }
        $content = implode("\n", $lines);
        if(count($lines) > 15) {
            //display first 10 lines
            $i = 0;
            echo "<pre>";
            for(;$i < 10; $i++) {
                echo $lines[$i]."\n";
            }
            echo "</pre>";
            //and toggle the rest..
            $out = "";
            $out .= "<pre>";
            for(;$i < count($lines);$i++) {
                $out .= $lines[$i]."\n";
            }
            $out .= "</pre>\n";
            echo outputToggle("Show More", "", $out);
        } else {
            //display all at once.
            echo "<pre>$content</pre>";
        }
        echo "</div>";
    }

}
?>
</div>
<?include("app/views/scripts/footer.phtml");?>
