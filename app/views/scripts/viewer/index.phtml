<?include("app/views/scripts/header.phtml");?>
<div class="bread">You are here &gt; <a href="<?=base()?>/opentickets">View Tickets</a> &gt; <?=$this->ticket_id?></div>
<?
if(isset($this->warning)) {
    echo "<p class=\"warning\">".$this->warning."</p>";
}
?>
<h2><?=$this->page_title?></h2>

<div style="float: right">
<h3>Ticket Info</h3>
<table>
<tr><td class="header">Ticket Type:</td><td><?=$this->ticket_type?></td></tr>
<tr><td class="header">Status:</td><td><?=$this->status?></td></tr>
<tr><td class="header">Priority:</td><td><?=$this->priority?></td></tr>
<tr><td class="header">Assignees:</td><td><?=$this->assignees?></td></tr>
<?
    if(user()->getPersonID() !== null) {
?>
<tr><td class="header personal">CC:</td><td><?=$this->cc?></td></tr>
<?
    }
?>
<tr><td class="header">Destination VO:</td><td><?=$this->destination_vo?></td></tr>
<tr><td class="header">Next Action Deadline:</td><td><?=$this->nad?></td></tr>
<tr><td class="header">Ready To Close:</td><td><?=$this->ready_to_close?></td></tr>
</table>
</div>

<div>
<h3>Submitter</h3>
<table>
<tr><td class="header">Name:</td><td><?=$this->submitter_name?></td></tr>
<tr><td class="header">VO:</td><td><?=$this->submitter_vo?></td></tr>
<?
    if(user()->getPersonID() !== null) {
        echo "<tr><td class=\"header personal\">Email:</td><td>".$this->submitter_email."</td></tr>";
        echo "<tr><td class=\"header personal\">Phone:</td><td>".$this->submitter_phone."</td></tr>";
    }
?>

</table>
</div>

<div style="clear: both;">
<h3>Updates</h3>
<br/>
<?
foreach($this->descs as $desc)
{
    $time = trim($desc["time"]);
    $by = trim($desc["by"]);
    $content = trim($desc["desc"]);

    //suppress metainfo..
    $metapos = strpos($content, config()->metatag);
    if($metapos !== FALSE) {
        //has metainfo.. replace it with filtered versionme
        $content = substr($content, 0, $metapos);
    }

    echo "<blockquote>";
    if($time > time() - 60*60*24) {
        //show in "ago" format
        $human_time = agoCalculation($time). " ago";
    } else {
        $human_time = date(config()->date_format_full, $time);
    }
    echo "<div class=\"author\">By <b>$by</b><br/>$human_time</div>";
    $lines_raw = split("\n", $content);
    $lines = array();
    foreach($lines_raw as $line) {
        $line = trim($line);
        if(strpos($line, "&#62") === 0) {
            $line = "<font color='#7F7E6F'>$line</font>";
        }
        $lines[] = $line;
    }
    if(count($lines) > 15) {
        //display first 10 lines
        $i = 0;
        echo "<pre>";
        for(;$i < 10; $i++) {
            echo $lines[$i]."\n";
        }
        echo "</pre>";
        //and toggle the rest..
        $out = "";
        $out .= "<pre>";
        for(;$i < count($lines);$i++) {
            $out .= $lines[$i]."\n";
        }
        $out .= "</pre>\n";
        echo outputToggle("Show More", "", $out);
    } else {
        //display all at once.
        echo "<pre>$content</pre>";
    }
    echo "</blockquote>";
}
?>
</div>
<?include("app/views/scripts/footer.phtml");?>
