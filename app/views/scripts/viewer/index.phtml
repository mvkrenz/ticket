<?php echo $this->render("bootheader.phtml", true);?>
<script type='text/javascript' src='lib/jquery.timeago.js'></script>

<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
}
#updates .header {
color: #666;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
</style>

<div class="container-fluid">

<?php if(isset($this->load_comet)) {?>
    <script type="text/javascript">
        var config = {
            ticket_id: <?=$this->ticket_id?>,
            contact_id: <?=$this->contact_id?>,
            contact_name: "<?=$this->contact_name?>"
        };
        function _update_ticket(data) {
            if(data.request) {
                if(data.request == "reload") {
                    var submitter = data.submitter;
                    if(confirm(data.submitter + " has submited an update to this ticket. Do you want to reload?")) {
                        history.go(0);
                    }
                }
            }
        }
        function _update_presence(presence) {
            var html = "";
            html += "<ul class=\"editors\">";
            var count = 0;
            for(var id in presence) {
                var contact_name = presence[id];
                if(contact_name !=  config.contact_name) {
                    html += "<li>" + contact_name + "</li>";
                    count++;
                }
            }
            html += "</ul>";
            if(count != 0) {
                html = "Viewers " + html;
            }
            $("#presence").html(html);
        }
        function _handshakeFailed() {
            $("#presence").html("<p class=\"warning\">Peer status unknown</p>");
        }
        $(function() {
            $("#ticket_form").submit(function() {
                $.cometd.publish("/ticket/<?=$this->ticket_id?>", { request: "reload", submitter: "<?=$this->contact_name?>" });
                return true;
            });
        });
    </script>
<?php } 

echo $this->alerts();
echo "<div id=\"presence\" class=\"pull-right\"></div>";
echo "<div class=\"ticketgui\">";
if($this->editable) {
    $suppression_control = true;
    include("app/views/scripts/ticket_editor.phtml");
} else {
    include("app/views/scripts/ticket_viewer.phtml");
}
echo "</div>";
?>

<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
        <div class="btn-group">
        <?php
        $sort_order = "down"; //default
        if(isset($_REQUEST["sort"])) {
            $sort_order = $_REQUEST["sort"];
        }
        if($sort_order == "down") {
            $flip_url = $this->updateurl(array("sort"=>"up"));
            $flip_button = "icon-arrow-up";
            krsort($this->descs, SORT_NUMERIC);
        } else {
            $flip_url = $this->updateurl(array("sort"=>"down"));
            $flip_button = "icon-arrow-down";
            ksort($this->descs, SORT_NUMERIC);
        }
        ?>
        <a class="btn btn-small" href="<?=$flip_url?>"><i class="<?=$flip_button?>"></i> Sort</a>

        <?
        $expand_all = false; 
        if(isset($_REQUEST["expandall"])) {
            if($_REQUEST["expandall"] == "true") {
                $expand_all = true;
            }
        }
        if(!$expand_all) {
            $expand_all_url = $this->updateurl(array("expandall"=>"true"));
            echo "<a class=\"btn btn-small\" href=\"$expand_all_url\">Expand Descriptions</a>";
        } else {
            $expand_all_url = $this->updateurl(array("expandall"=>"false"));
            echo "<a class=\"btn active btn-small\" href=\"$expand_all_url\">Expand All Descriptions</a>";
        }

        $subject = "Open Science Grid: $this->title ISSUE=$this->ticket_id PROJ=".config()->project_id;
        ?>
        <a class="btn btn-small" target="_blank" href="mailto:<?=config()->ticket_update_address?>?subject=<?=rawurlencode($subject)?>"><i class="icon-envelope"></i> Update w/Email</a>
        </div>
    </div><!--btn-toolbar-->
    </legend>

    <?
    foreach($this->descs as $time=>$desc)
    {
        $by = $desc["by"];
        $content = trim($desc["content"]);
        $type = $desc["type"];

        //hide meta information if user doesn't have metatag access
        if(!user()->allows("view_meta")) {
            //hide it!
            $metapos = strpos($content, config()->metatag);
            if($metapos !== FALSE) {
                //has metainfo.. hide it
                $content = substr($content, 0, $metapos);
            }
        } else {
            //show it!
            $metapos = strpos($content, config()->metatag);
            if($metapos !== FALSE) {
                //has metainfo.. let's split the ticket into 2 parts
                $meta_information = substr($content, $metapos + strlen(config()->metatag));
                $content = substr($content, 0, $metapos);
            } else {
                $meta_information = null;
            }
        }

        /*
        if($time > time() - 60*60*24) {
            //show in "ago" format
            $detail = date(config()->date_format_full, $time);
            $ago = agoCalculation($time). " ago";
            $human_time = "<span onmouseover=\"$(this).text('$detail');\" onmouseout=\"$(this).text('$ago');\">$ago</span>";
        } else {
            $human_time = date(config()->date_format_full, $time);
        }
        */

        $iso = date("c", $time);
        $timestr = date(config()->date_format_full, $time);
        $human_time = "<time datetime=\"$iso\">$timestr</time>";

        //history == internal activities
        if($type == "history") {
            echo "<div class='update_history'>";
            //$out = "<div class=\"header\">$human_time</div>";
            echo "<pre>".Footprint::parse($content)."</pre>";
            //echo outputToggle("<span class=\"header clickable\">Show Footprints Activities ($human_time)</span>", "", $out);
            echo "</div>";
        }
        
        if($type == "description") {
            if(user()->isGuest()) {
                //mask email address
                if(preg_match('/^[^@]+@[a-zA-Z0-9._-]+\.[a-zA-Z]+$/', $by)) {
                    $by = substr($by, 0, strpos($by, "@"))."@....";
                }
            }

            $anchor = $time;
            echo "<div class='update_description'>";
            echo "<i onclick=\"document.location='".$this->ticket_id."#$anchor'; reset_anchor();\" class=\"pull-right icon icon-share\"></i>";
            echo "<div class=\"header\">";
            echo "$human_time";
            if($by != "goc") {
                //this means update was made by fpuser:goc onbehalf of user who doesn't have footprints account
                echo " by <b>$by</b>";
            }
            echo "<a class=\"anchor\" name=\"$anchor\">&nbsp;</a>";
            echo "</div>";
            $lines_raw = explode("\n", $content);
            $lines = array();
            foreach($lines_raw as $line) {
                $line = trim($line);
                if(strpos($line, "&#62;") === 0) {
                    $line = "<font color='#7F7E6F'>$line</font>";
                }
                $lines[] = $line;
            }
            $content = trim(implode("\n", $lines));
            if(!isset($_REQUEST["expandall"]) && count($lines) > config()->description_showlines) {
                $i = 0;
                echo "<pre>";
                for(;$i < config()->description_showlines; $i++) {
                    echo $lines[$i]."\n";
                }
                //and toggle the rest..
                $out = "";
                for(;$i < count($lines);$i++) {
                    $out .= $lines[$i]."\n";
                }
                echo outputToggle("<button class=\"btn\">Show More</button>", "", $out);
                echo "</pre>";

            } else {
                //display all at once.
                echo "<pre>$content</pre>";
            }
            echo "</div>";//update_description
        }

        //meta information
        if(!empty($meta_information)) {
            echo "<div class=\"meta_information\">";
            $out = "<pre>$meta_information</pre>";
            //echo outputToggle("<button class=\"btn btn-warning btn-small\">Show Ticket Creation Information</button>", "", $out);
            echo $out;
            echo "</div>";
        }
    }

    echo "<legend>Similar Recent Tickets <small>modified within the last 30 days</small></legend>";
    echo "<div id=\"similar_tickets\">";
    if(isset($this->similar_tickets) && count($this->similar_tickets) > 0) { 
        foreach($this->similar_tickets as $ticket) {
            echo "<a href=\"".$ticket->id."\"><b>".$ticket->id."</b> ".$ticket->title." (".$ticket->status.")</a><p>".$ticket->desc."</p>";
        }
    } else {
        echo "<p class=\"muted\">No similar tickets found.</p>";
    }
    echo "</div>";

?>

</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");

    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener) {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }

        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }

    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();

    var expanded = false;
    $(".description").focus(function() {
        if(!expanded) {
            expanded = true;
            //expand to minheight
            var min = 200;
            if($(this).height() < min) {
                $(this).animate({height: min}, 500);
            }
        }
    });
});

</script>
<?php echo $this->render("pagefooter.phtml", true);?>
</div><!--container-fluid-->
<?php echo $this->render("bootfooter.phtml", true);?>
